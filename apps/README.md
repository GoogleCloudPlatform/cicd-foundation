# Applications

This directory hosts demo applications in kind of a mono-repository.

## Directory Structure

The directory structure is as follows:

### Environment File

The following environment file is read by `/bin/` scripts when `envsubst`ing
template files, starting services locally, or deploying to CloudRun:
```sh
/apps/.env
```

You can use it to define (default) (global) variables that apply to any
application and environment.
You can overwrite variables for an application in these file(s):

```sh
/apps/${APP_NAME}/envs/base/.env
```
and/or further refine it for a specific environment:
```sh
/apps/${APP_NAME}/envs/{ENV_NAME}/.env
```

### Application Directory

```sh
/apps/${APP_NAME}/
```
hosts an application or micro-service named `$APP_NAME`.
The granularity of such application should be a (consumable) service in the scale of a pod,
i.e., one or more containers running in one GKE Pod or Cloud Run instance.

#### skaffold.yaml

Each such directory corresponds to a Skaffold project and must contain a
```sh
/apps/${APP_NAME}/skaffold.yaml
```
file that describes the project's dependencies, and/or how it
can be built, tested, validated, and/or deployed
(cf. [skaffold.yaml reference](https://skaffold.dev/docs/references/yaml/)).

#### Environment Definitions

```sh
/apps/${APP_NAME}/envs/${ENV_NAME}/
```

Typical environment names are `dev`, `test`, and `prod` for development, testing, and production environments.

`base` is a special directory and is used as a base for the actual environments (having a different name).

##### Kustomize

For Kubernetes manifests `kustomize` (part of `kubectl`) is leveraged and referenced as part of `skaffold` `profiles`:
```sh
/apps/${APP_NAME}/envs/${ENV_NAME}/kustomization.yaml
```

##### Template Files

The `base` directory may contain a template of a manifest file for Knative services and/or jobs:
```sh
/apps/${APP_NAME}/envs/base/knative.yaml.tmpl
```

Environment substitution (`envsubst`) is realized by executing `/bin/generate.sh` (called by `skaffold.yaml`).
The latter script generates `knative.yaml` files in the environment directories.
These need to be checked into the version control system (VCS) for Cloud Deploy rollouts to be picked up
(as the generation cannot be done as part of rendering steps).

The templating approach is adopted as CloudRun does not support namespaces
(in contrast to GKE) and we use pre- and postfixes as part of the name.

In addition to the global (`/apps/.env`) environment file (see above), application specific
```sh
/apps/${APP_NAME}/envs/base/.env
```
 and environment specific files
```sh
/apps/${APP_NAME}/envs/${ENV_NAME}/.env
```
can be provided, e.g., to overwrite default and/or to define application
or environment specific values.

#### Source Code

##### Infrastructure-as-Code (optional)

Code for the deployment of infrastructure - specifically required for the application
(in contrast to predeployed and available shared resources such as Kubernetes clusters)
- should be stored in

```sh
/apps/${APP_NAME}/src/infra/
```

##### Application Code

An application may consist of one or more containers to be deployed.
The source code for a container (image) is stored in this directory:

```sh
/apps/${APP_NAME}/src/${CONTAINER_NAME}/
```

If the application consist of only one container, `${CONTAINER_NAME}` should equal `${APP_NAME}` as a best practice.

###### Procfile

For `buildpacks` the definition of a Procfile may be required to advise how to start the application:

```sh
/apps/${APP_NAME}/src/${CONTAINER_NAME}/Procfile
```

This file is (also) consulted when executing `/bin/run.sh` for local development.

##### Misc (optional)

Other code, not directly associated with a container can be placed in other directories.

```sh
/apps/${APP_NAME}/src/${OTHER_CODE}/
```

An example are [Protocol Buffers](https://protobuf.dev/): `.proto` files can be defined
for generating code used by the service(s). These can be placed in:

```sh
/apps/${APP_NAME}/src/protos/
```

##### Language Specific Conventions

###### Java

A Maven-managed Java project should define:

```sh
/apps/${APP_NAME}/src/${CONTAINER_NAME}/pom.xml
```

###### Python

A Python project (e.g., managed by `poetry`) should define:

```sh
/apps/${APP_NAME}/src/${CONTAINER_NAME}/pyproject.toml
```

The

```sh
/apps/${APP_NAME}/src/${CONTAINER_NAME}/requirements.txt
```

file, generated by `poetry` via the `/bin/generate.sh` script needs to be checked into the VCS for `buildpacks`.

---

## Design Decisions

### Skaffold Projects

#### Options

1. Reference Skaffold Configs.
1. Skaffold Config with multiple services.

#### Decision

The approach (Option 1) used by
https://github.com/GoogleCloudPlatform/bank-of-anthos/blob/main/skaffold.yaml
is adapted in contrast to this example (Option 2):
https://github.com/GoogleContainerTools/skaffold/blob/main/examples/microservices/skaffold.yaml

#### Details

Building multiple containers in one `skaffold` project is OK if they are used
within one Pod / CloudRun instance otherwise
split `skaffold.yaml` and reference required configs in
multi-microservices project's `skaffold.yaml`.

Each `skaffold.yaml` with `deploy` stanza corresponds to a CI trigger & CD pipeline.
For creating such CI trigger and CD pipline via Infra-as-Code (Ia),
append the directory name to the `apps` list of `variables.tf` or within your `terraform.tfvars`.
